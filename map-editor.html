<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drunk Simulator - Map Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            font-family: monospace;
            background: #222;
            color: #fff;
            padding: 10px;
            margin: 0;
            overflow: hidden;
        }
        #grid-container {
            flex: 1;
            overflow: auto;
            border: 2px solid #fff;
            background: #000;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            max-height: 100%;
            padding: 20px;
            cursor: grab;
        }
        #grid-container:active {
            cursor: grabbing;
        }
        #grid {
            display: inline-block;
            transform-origin: center center;
            transition: transform 0.2s;
            position: relative;
        }
        .zoom-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        .zoom-label {
            background: #444;
            padding: 10px 15px;
            font-family: monospace;
            font-size: 14px;
            border-radius: 3px;
        }
        .row {
            display: flex;
            height: 32px;
        }
        .cell {
            width: 32px;
            height: 32px;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }
        .cell:hover {
            border: 1px solid #fff;
        }
        .palette {
            margin: 20px 0;
        }
        .palette-tile {
            display: inline-block;
            width: 24px;
            height: 24px;
            margin: 3px;
            border: 2px solid #fff;
            cursor: pointer;
        }
        .palette-tile.selected {
            border: 2px solid #0f0;
            box-shadow: 0 0 8px #0f0;
        }
        button {
            background: #666;
            color: #fff;
            border: none;
            padding: 10px 20px;
            font-family: monospace;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #888;
        }
        button:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
        }
        .cta-button {
            background: #2563eb;
            color: #fff;
            font-weight: bold;
        }
        .cta-button:hover {
            background: #1d4ed8;
        }
        .fill-preview {
            position: absolute;
            border: 3px solid #00ff00;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 0 10px #00ff00;
        }
        .container {
            display: flex;
            gap: 20px;
            align-items: stretch;
            height: calc(100vh - 60px);
            max-height: calc(100vh - 60px);
            overflow: hidden;
        }
        .palette-column {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            flex-shrink: 0;
            width: 160px;
            overflow-y: auto;
            max-height: 100%;
            align-content: start;
        }
        .buttons-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-shrink: 0;
            width: 180px;
            overflow-y: auto;
            max-height: 100%;
        }
        #output {
            background: #000;
            padding: 10px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: scroll;
            font-size: 11px;
        }
        .info {
            background: #333;
            padding: 10px;
            margin: 10px 0;
        }
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            padding: 12px 20px;
            background: #333;
            margin: 0;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left: Tile Palette (Vertical) -->
        <div class="palette-column">
            <div style="display: flex; flex-direction: column; align-items: center; gap: 3px;">
                <div class="palette-tile" data-type="0" style="background: #707070;"></div>
                <span style="font-size: 9px;">Street</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 3px;">
                <div class="palette-tile" data-type="1" style="background: #D2B48C;"></div>
                <span style="font-size: 9px;">Bar Floor</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 3px;">
                <div class="palette-tile" data-type="2" style="background: #A0A0A0;"></div>
                <span style="font-size: 9px;">Patio</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 3px;">
                <div class="palette-tile" data-type="3" style="background: #8B4513;"></div>
                <span style="font-size: 9px;">Wall</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 3px;">
                <div class="palette-tile" data-type="4" style="background: #000000; border-color: #fff;"></div>
                <span style="font-size: 9px;">Door</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 3px;">
                <div class="palette-tile selected" data-type="5" style="background: #654321;"></div>
                <span style="font-size: 9px;">Counter</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 3px;">
                <div class="palette-tile" data-type="6" style="background: #4169E1;"></div>
                <span style="font-size: 9px;">Staff</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 3px;">
                <div class="palette-tile" data-type="7" style="background: #6B5F47;"></div>
                <span style="font-size: 9px;">Stairs</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 3px;">
                <div class="palette-tile" data-type="8" style="background: #00ff00;"></div>
                <span style="font-size: 9px;">Player</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 3px;">
                <div class="palette-tile" data-type="9" style="background: #FFFF00;"></div>
                <span style="font-size: 9px;">Beer Tap</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 3px;">
                <div class="palette-tile" data-type="10" style="background: #ff0000;"></div>
                <span style="font-size: 9px;">Employee</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 3px;">
                <div class="palette-tile" data-type="11" style="background: #FFA500;"></div>
                <span style="font-size: 9px;">Patron Spawn</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 3px;">
                <div class="palette-tile" data-type="12" style="background: #00FFFF;"></div>
                <span style="font-size: 9px;">Camera Start</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 3px;">
                <div class="palette-tile" data-type="13" style="background: #9B30FF;"></div>
                <span style="font-size: 9px;">POI</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 3px;">
                <div class="palette-tile" data-type="14" style="background: #2C5F2D;"></div>
                <span style="font-size: 9px;">Chair</span>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 3px;">
                <div class="palette-tile" data-type="15" style="background: #228B22;"></div>
                <span style="font-size: 9px;">Cash Reg</span>
            </div>

            <!-- Map Size Controls -->
            <div style="grid-column: 1 / -1; margin-top: 20px; padding: 10px; background: #333; border-radius: 3px;">
                <div id="map-size-label" style="font-size: 12px; margin-bottom: 8px; font-weight: bold; text-align: center;">Map Size (1,400 tiles)</div>

                <div style="margin-bottom: 8px;">
                    <label style="font-size: 10px; display: block; margin-bottom: 3px;">Width (cols)</label>
                    <input type="number" id="map-width" min="10" max="60" value="40"
                           style="width: 100%; padding: 5px; background: #444; border: 1px solid #666; color: #fff; border-radius: 3px;">
                </div>

                <div style="margin-bottom: 8px;">
                    <label style="font-size: 10px; display: block; margin-bottom: 3px;">Height (rows)</label>
                    <input type="number" id="map-height" min="10" max="100" value="35"
                           style="width: 100%; padding: 5px; background: #444; border: 1px solid #666; color: #fff; border-radius: 3px;">
                </div>

                <button onclick="resizeMap()" style="width: 100%; padding: 8px; margin-bottom: 8px; background: #2563eb; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: bold;">
                    Apply
                </button>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px; margin-bottom: 8px;">
                    <button onclick="setPresetSize(10, 18)" style="padding: 5px; background: #444; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 8px;">
                        Tiny<br>10√ó18
                    </button>
                    <button onclick="setPresetSize(15, 27)" style="padding: 5px; background: #444; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 8px;">
                        Mini<br>15√ó27
                    </button>
                    <button onclick="setPresetSize(20, 36)" style="padding: 5px; background: #444; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 8px;">
                        Small<br>20√ó36
                    </button>
                    <button onclick="setPresetSize(25, 44)" style="padding: 5px; background: #444; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 8px;">
                        Medium<br>25√ó44
                    </button>
                    <button onclick="setPresetSize(30, 53)" style="padding: 5px; background: #444; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 8px;">
                        Large<br>30√ó53
                    </button>
                    <button onclick="setPresetSize(40, 70)" style="padding: 5px; background: #444; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 8px;">
                        XL<br>40√ó70
                    </button>
                </div>

                <div id="size-info" style="font-size: 9px; color: #aaa; margin-bottom: 8px; text-align: center;">
                    QR v25 ‚Ä¢ 936 chars
                </div>

                <button id="fill-btn" onclick="startFillMode()" style="width: 100%; padding: 6px; margin-bottom: 3px; background: #444; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 10px;">
                    Fill Rectangle
                </button>
                <button onclick="clearGrid()" style="width: 100%; padding: 6px; background: #444; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-size: 10px;">
                    Clear All
                </button>
            </div>
        </div>

        <!-- Center: Grid -->
        <div id="grid-container">
            <div id="grid"></div>
        </div>

        <!-- Right: Buttons (Vertical) -->
        <div class="buttons-column">
            <button class="cta-button" onclick="saveMap()">üíæ Save Map</button>
            <button class="cta-button" onclick="copyToClipboard()">üìã Copy Map</button>

            <div style="margin: 10px 0; padding: 10px; background: #333; border-radius: 3px;">
                <div style="font-size: 12px; margin-bottom: 5px;">Saved Maps:</div>
                <div id="saved-maps-list" style="max-height: 150px; overflow-y: auto; font-size: 11px;"></div>
            </div>

            <button onclick="importFromCode()">üì• Import from Code</button>
            <button class="cta-button" onclick="showQROverlay()">üì± Show QR Code</button>

            <div class="zoom-controls">
                <button onclick="zoomIn()">Zoom +</button>
                <button onclick="zoomOut()">Zoom -</button>
                <button onclick="zoomFit()">Fit All</button>
            </div>
            <div class="zoom-label" id="zoom-level">100%</div>
            <button onclick="centerMap()">üéØ Center</button>
            <button id="undo-btn" onclick="undo()" disabled>‚Ü©Ô∏è Undo (0)</button>
            <button onclick="loadFromImage()">Load from PNG</button>
        </div>
    </div>

    <div class="status-bar">
        <span id="status">Map ready. Paint tiles to edit.</span>
    </div>

    <!-- QR Code Overlay -->
    <div id="qr-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; text-align: center; position: relative;">
            <button onclick="hideQROverlay()" style="position: absolute; top: 10px; right: 10px; background: transparent; color: #000; border: none; width: 30px; height: 30px; cursor: pointer; font-size: 28px; font-weight: bold; line-height: 1;">√ó</button>
            <h2 style="margin: 0 0 20px 0; color: #222; font-family: monospace;">Scan to Share Map</h2>
            <div id="qr-overlay-container"></div>
            <div id="qr-overlay-info" style="margin-top: 15px; font-size: 14px; color: #666; font-family: monospace;"></div>
            <button onclick="saveQRCodePNG()" style="margin-top: 20px; padding: 10px 20px; background: #2563eb; color: #fff; border: none; border-radius: 5px; font-family: monospace; font-size: 16px; cursor: pointer; font-weight: bold;">üíæ Save PNG</button>
        </div>
    </div>

    <script>
        const COLORS = {
            0: '#707070',  // Street
            1: '#D2B48C',  // Bar floor
            2: '#A0A0A0',  // Patio
            3: '#8B4513',  // Wall
            4: '#000000',  // Door
            5: '#654321',  // Bar counter
            6: '#4169E1',  // Staff zone
            7: '#6B5F47',  // Stairs
            8: '#00ff00',  // Player start marker
            9: '#FFFF00',  // Beer tap (yellow)
            10: '#ff0000', // Employee spawn marker
            11: '#FFA500', // Patron spawn marker
            12: '#00FFFF', // Camera start marker (cyan)
            13: '#9B30FF', // POI - Point of Interest (purple)
            14: '#2C5F2D', // Chair - dark forest green
            15: '#228B22'  // Cash Register - money green
        };

        let COLS = 40;  // Default map size
        let ROWS = 35;
        let selectedType = 5;
        let grid = [];
        let isMouseDown = false;
        let zoomLevel = 1.0;
        let history = [];
        const MAX_HISTORY = 20;
        let fillMode = false;
        let fillStart = null;
        let fillPreview = null;

        // Initialize grid with default size
        function initGrid() {
            // Blank 40√ó35 grid - start designing!
            grid = Array(35).fill(null).map(() => Array(40).fill(0));
        }

        function renderGrid() {
            const gridEl = document.getElementById('grid');
            gridEl.innerHTML = '';

            for (let row = 0; row < ROWS; row++) {
                const rowEl = document.createElement('div');
                rowEl.className = 'row';

                for (let col = 0; col < COLS; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.style.background = COLORS[grid[row][col]];
                    cell.dataset.row = row;
                    cell.dataset.col = col;

                    cell.addEventListener('mousedown', (e) => {
                        if (fillMode) {
                            e.preventDefault();
                            handleFillClick(row, col);
                        } else {
                            isMouseDown = true;
                            saveHistory(); // Save state before making changes
                            paintCell(row, col);
                        }
                    });
                    cell.addEventListener('mouseenter', () => {
                        if (fillMode) {
                            updateFillPreview(row, col);
                        } else if (isMouseDown) {
                            paintCell(row, col);
                        }
                    });
                    cell.addEventListener('contextmenu', (e) => {
                        if (fillMode) {
                            e.preventDefault();
                            cancelFillMode();
                        }
                    });

                    rowEl.appendChild(cell);
                }
                gridEl.appendChild(rowEl);
            }
        }

        function saveHistory() {
            // Deep copy the grid
            const gridCopy = grid.map(row => [...row]);
            history.push(gridCopy);

            // Limit history to MAX_HISTORY entries
            if (history.length > MAX_HISTORY) {
                history.shift();
            }

            updateUndoButton();
        }

        function undo() {
            if (history.length === 0) {
                document.getElementById('status').textContent = '‚ö†Ô∏è Nothing to undo!';
                return;
            }

            // Restore previous state
            grid = history.pop();
            renderGrid();
            updateUndoButton();
            document.getElementById('status').textContent = `‚Ü©Ô∏è Undo applied (${history.length} steps remaining)`;
        }

        function updateUndoButton() {
            const undoBtn = document.getElementById('undo-btn');
            if (undoBtn) {
                undoBtn.disabled = history.length === 0;
                undoBtn.textContent = `‚Ü©Ô∏è Undo (${history.length})`;
            }
        }

        function paintCell(row, col) {
            // If painting a camera start tile (type 12), remove any existing one
            if (selectedType === 12) {
                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        if (grid[r][c] === 12) {
                            grid[r][c] = 0; // Replace with street
                            const oldCell = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                            if (oldCell) {
                                oldCell.style.background = COLORS[0];
                            }
                        }
                    }
                }
            }

            grid[row][col] = selectedType;
            const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            cell.style.background = COLORS[selectedType];
            // Auto-update status
            document.getElementById('status').textContent = `Last edit: Row ${row}, Col ${col} ‚Üí Type ${selectedType}`;
        }

        document.addEventListener('mouseup', () => {
            isMouseDown = false;
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Escape to cancel fill mode
            if (e.key === 'Escape' && fillMode) {
                e.preventDefault();
                cancelFillMode();
            }
            // Ctrl+Z or Cmd+Z for undo
            else if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                undo();
            }
        });

        // Palette selection
        document.querySelectorAll('.palette-tile').forEach(tile => {
            tile.addEventListener('click', () => {
                document.querySelectorAll('.palette-tile').forEach(t => t.classList.remove('selected'));
                tile.classList.add('selected');
                selectedType = parseInt(tile.dataset.type);
            });
        });

        function copyToClipboard() {
            let code = 'const map: number[][] = [\n';
            for (let row = 0; row < ROWS; row++) {
                code += '    [' + grid[row].join(',') + '],\n';
            }
            code += '];';

            navigator.clipboard.writeText(code).then(() => {
                document.getElementById('status').textContent = '‚úÖ Map copied to clipboard!';
                setTimeout(() => {
                    document.getElementById('status').textContent = 'Map ready. Paint tiles to edit.';
                }, 2000);
            }).catch(err => {
                document.getElementById('status').textContent = '‚ùå Failed to copy: ' + err;
            });
        }

        function clearGrid() {
            if (confirm('Clear the entire grid?')) {
                saveHistory();
                grid = Array(ROWS).fill(null).map(() => Array(COLS).fill(0)); // Fill with street tiles
                renderGrid();
                document.getElementById('status').textContent = '‚úÖ Grid cleared';
            }
        }

        function startFillMode() {
            // Prevent camera start tile from being used in fill mode
            if (selectedType === 12) {
                document.getElementById('status').textContent = '‚ö†Ô∏è Cannot use Camera Start tile in Fill Rectangle mode';
                return;
            }

            fillMode = true;
            fillStart = null;
            document.getElementById('status').textContent = 'üî≤ Fill Mode: Click first corner of rectangle';
            document.getElementById('fill-btn').textContent = 'Cancel Fill (ESC)';
            document.getElementById('fill-btn').onclick = cancelFillMode;
        }

        function cancelFillMode() {
            fillMode = false;
            fillStart = null;
            if (fillPreview) {
                fillPreview.remove();
                fillPreview = null;
            }
            document.getElementById('status').textContent = 'Fill mode cancelled';
            document.getElementById('fill-btn').textContent = 'Fill Rectangle';
            document.getElementById('fill-btn').onclick = startFillMode;
        }

        function handleFillClick(row, col) {
            if (!fillStart) {
                // First click - set start corner
                fillStart = {row, col};
                document.getElementById('status').textContent = 'üî≤ Fill Mode: Click second corner of rectangle (or ESC/right-click to cancel)';
            } else {
                // Second click - fill the rectangle
                const startRow = Math.min(fillStart.row, row);
                const endRow = Math.max(fillStart.row, row);
                const startCol = Math.min(fillStart.col, col);
                const endCol = Math.max(fillStart.col, col);

                saveHistory();
                for (let r = startRow; r <= endRow; r++) {
                    for (let c = startCol; c <= endCol; c++) {
                        grid[r][c] = selectedType;
                    }
                }
                renderGrid();

                // Exit fill mode
                cancelFillMode();
                document.getElementById('status').textContent = `‚úÖ Filled rectangle from (${startRow},${startCol}) to (${endRow},${endCol})`;
            }
        }

        function updateFillPreview(row, col) {
            if (!fillStart || !fillMode) return;

            const gridEl = document.getElementById('grid');

            // Remove old preview
            if (fillPreview) {
                fillPreview.remove();
            }

            // Calculate rectangle bounds
            const startRow = Math.min(fillStart.row, row);
            const endRow = Math.max(fillStart.row, row);
            const startCol = Math.min(fillStart.col, col);
            const endCol = Math.max(fillStart.col, col);

            // Create preview element positioned relative to grid (not container)
            fillPreview = document.createElement('div');
            fillPreview.className = 'fill-preview';
            fillPreview.style.position = 'absolute';
            fillPreview.style.left = `${startCol * 32}px`;
            fillPreview.style.top = `${startRow * 32}px`;
            fillPreview.style.width = `${(endCol - startCol + 1) * 32}px`;
            fillPreview.style.height = `${(endRow - startRow + 1) * 32}px`;

            gridEl.appendChild(fillPreview);
        }

        // Zoom functions
        function updateZoom() {
            const gridEl = document.getElementById('grid');
            gridEl.style.transform = `scale(${zoomLevel})`;
            document.getElementById('zoom-level').textContent = `${Math.round(zoomLevel * 100)}%`;
        }

        function zoomIn() {
            zoomLevel = Math.min(2.0, zoomLevel + 0.1);
            updateZoom();
        }

        function zoomOut() {
            zoomLevel = Math.max(0.1, zoomLevel - 0.1);
            updateZoom();
        }

        function zoomFit() {
            const container = document.getElementById('grid-container');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            const gridWidth = COLS * 32;
            const gridHeight = ROWS * 32;

            const scaleX = containerWidth / gridWidth;
            const scaleY = containerHeight / gridHeight;

            zoomLevel = Math.min(scaleX, scaleY) * 0.95; // 95% to add some padding
            updateZoom();
        }

        // Position viewport at camera start tile if it exists
        function centerOnCameraStart() {
            const container = document.getElementById('grid-container');

            // Find camera start tile (type 12) in grid
            for (let row = 0; row < ROWS; row++) {
                for (let col = 0; col < COLS; col++) {
                    if (grid[row][col] === 12) {
                        // Found camera start - center it
                        const tileX = col * 32 * zoomLevel;
                        const tileY = row * 32 * zoomLevel;

                        const centerX = tileX - (container.clientWidth / 2) + (16 * zoomLevel);
                        const centerY = tileY - (container.clientHeight / 2) + (16 * zoomLevel);

                        container.scrollLeft = Math.max(0, centerX);
                        container.scrollTop = Math.max(0, centerY);

                        console.log(`üì∑ Centered on camera start at row ${row}, col ${col}`);
                        return;
                    }
                }
            }

            // No camera start - default to top
            container.scrollTop = 0;
            container.scrollLeft = 0;
        }

        // Save/Load functions
        function saveMap() {
            const mapName = prompt('Enter a name for this map:');
            if (!mapName) {
                document.getElementById('status').textContent = '‚ùå Save cancelled';
                return;
            }

            const mapData = {
                name: mapName,
                grid: grid,
                timestamp: Date.now()
            };

            // Get existing maps
            const savedMaps = JSON.parse(localStorage.getItem('drunkSimMaps') || '[]');

            // Check if name exists
            const existingIndex = savedMaps.findIndex(m => m.name === mapName);
            if (existingIndex >= 0) {
                if (!confirm(`Map "${mapName}" already exists. Overwrite?`)) {
                    document.getElementById('status').textContent = '‚ùå Save cancelled';
                    return;
                }
                savedMaps[existingIndex] = mapData;
            } else {
                savedMaps.push(mapData);
            }

            localStorage.setItem('drunkSimMaps', JSON.stringify(savedMaps));
            document.getElementById('status').textContent = `‚úÖ Map "${mapName}" saved!`;
            updateSavedMapsList();
        }

        function loadMap(mapName) {
            const savedMaps = JSON.parse(localStorage.getItem('drunkSimMaps') || '[]');
            const mapData = savedMaps.find(m => m.name === mapName);

            if (mapData) {
                saveHistory(); // Save current state to undo

                // Get loaded map dimensions
                const loadedHeight = mapData.grid.length;
                const loadedWidth = mapData.grid[0]?.length || 0;

                // Update global dimensions
                ROWS = loadedHeight;
                COLS = loadedWidth;

                // Update input fields
                document.getElementById('map-width').value = loadedWidth;
                document.getElementById('map-height').value = loadedHeight;

                // Update size info
                updateSizeInfo();

                // Load the grid
                grid = mapData.grid;
                renderGrid();

                document.getElementById('status').textContent = `‚úÖ Loaded map "${mapName}" (${loadedWidth}√ó${loadedHeight})`;
            } else {
                document.getElementById('status').textContent = `‚ùå Map "${mapName}" not found`;
            }
        }

        function deleteMap(mapName) {
            if (!confirm(`Delete map "${mapName}"?`)) return;

            const savedMaps = JSON.parse(localStorage.getItem('drunkSimMaps') || '[]');
            const filtered = savedMaps.filter(m => m.name !== mapName);
            localStorage.setItem('drunkSimMaps', JSON.stringify(filtered));

            document.getElementById('status').textContent = `üóëÔ∏è Deleted map "${mapName}"`;
            updateSavedMapsList();
        }

        function updateSavedMapsList() {
            const savedMaps = JSON.parse(localStorage.getItem('drunkSimMaps') || '[]');
            const listEl = document.getElementById('saved-maps-list');

            if (savedMaps.length === 0) {
                listEl.innerHTML = '<div style="color: #888; font-style: italic;">No saved maps</div>';
                return;
            }

            listEl.innerHTML = savedMaps.map(map => {
                const date = new Date(map.timestamp).toLocaleString();
                return `
                    <div style="margin-bottom: 8px; padding: 5px; background: #444; border-radius: 3px;">
                        <div style="font-weight: bold;">${map.name}</div>
                        <div style="font-size: 9px; color: #aaa;">${date}</div>
                        <div style="margin-top: 3px;">
                            <button onclick="loadMap('${map.name}')" style="font-size: 10px; padding: 3px 6px;">Load</button>
                            <button onclick="deleteMap('${map.name}')" style="font-size: 10px; padding: 3px 6px; background: #a00;">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================================
        // QR CODE COMPRESSION & SHARING
        // ============================================================

        /**
         * Compress map grid into Base64 string for QR encoding
         */
        function compressMap(gridData) {
            const height = gridData.length;
            const width = gridData[0]?.length || 0;

            // Flatten grid into 1D array
            const tiles = [];
            for (let row = 0; row < height; row++) {
                for (let col = 0; col < width; col++) {
                    tiles.push(gridData[row][col]);
                }
            }

            // Pack two 4-bit tiles into each byte
            const bytes = [];
            for (let i = 0; i < tiles.length; i += 2) {
                const tile1 = tiles[i];
                const tile2 = tiles[i + 1] || 0;
                const packed = (tile1 << 4) | tile2;
                bytes.push(packed);
            }

            // Prepend width and height
            const header = [width, height];
            const fullData = [...header, ...bytes];

            // Convert to Base64
            const binaryString = String.fromCharCode(...fullData);
            const base64 = btoa(binaryString);

            return base64;
        }

        /**
         * Decompress Base64 string back into map grid
         */
        function decompressMap(base64) {
            const binaryString = atob(base64);
            const bytes = [];
            for (let i = 0; i < binaryString.length; i++) {
                bytes.push(binaryString.charCodeAt(i));
            }

            const width = bytes[0];
            const height = bytes[1];
            const dataBytes = bytes.slice(2);

            // Unpack tiles
            const tiles = [];
            for (const byte of dataBytes) {
                const tile1 = (byte >> 4) & 0x0F;
                const tile2 = byte & 0x0F;
                tiles.push(tile1, tile2);
            }

            tiles.length = width * height;

            // Reconstruct 2D grid
            const gridData = [];
            for (let row = 0; row < height; row++) {
                const rowData = [];
                for (let col = 0; col < width; col++) {
                    const index = row * width + col;
                    rowData.push(tiles[index]);
                }
                gridData.push(rowData);
            }

            return { grid: gridData, width, height };
        }

        /**
         * Show QR code in overlay
         */
        function showQROverlay() {
            try {
                const compressed = compressMap(grid);
                const compressedSize = Math.ceil(compressed.length * 3 / 4);
                const qrVersion = getQRVersion(compressed.length);

                // Clear previous QR code
                const container = document.getElementById('qr-overlay-container');
                const qrInfo = document.getElementById('qr-overlay-info');
                container.innerHTML = '';

                // Generate large QR code
                const qr = new QRCode(container, {
                    text: compressed,
                    width: 400,
                    height: 400,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });

                qrInfo.textContent = `Map: ${COLS}√ó${ROWS} (${compressedSize} bytes ‚Ä¢ ${compressed.length} chars)`;

                // Update status bar with QR version
                document.getElementById('status').textContent = `üì± QR Code v${qrVersion} ‚Ä¢ ${compressed.length} chars ‚Ä¢ ${COLS}√ó${ROWS} map`;

                // Show overlay
                document.getElementById('qr-overlay').style.display = 'flex';
            } catch (error) {
                console.error('QR generation failed:', error);
                alert('Failed to generate QR code: ' + error.message);
            }
        }

        /**
         * Hide QR code overlay
         */
        function hideQROverlay() {
            document.getElementById('qr-overlay').style.display = 'none';
        }

        /**
         * Save QR code as PNG
         */
        function saveQRCodePNG() {
            const container = document.getElementById('qr-overlay-container');
            const canvas = container.querySelector('canvas');

            if (!canvas) {
                alert('No QR code to save!');
                return;
            }

            // Generate filename with map dimensions and timestamp
            const timestamp = new Date().toISOString().slice(0, 10);
            const filename = `drunk-sim-map-${COLS}x${ROWS}-${timestamp}.png`;

            // Convert canvas to blob and download
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                document.getElementById('status').textContent = `üíæ QR code saved as ${filename}`;
            });
        }

        /**
         * Import map from compressed code
         */
        function importFromCode() {
            const code = prompt('Paste the compressed map code (Base64 string):');
            if (!code) {
                document.getElementById('status').textContent = '‚ùå Import cancelled';
                return;
            }

            try {
                saveHistory(); // Save current state before importing
                const { grid: importedGrid, width, height } = decompressMap(code);

                if (width !== COLS || height !== ROWS) {
                    if (!confirm(`Imported map is ${width}√ó${height}, but editor is ${COLS}√ó${ROWS}. Import anyway?`)) {
                        document.getElementById('status').textContent = '‚ùå Import cancelled';
                        return;
                    }
                }

                grid = importedGrid;
                renderGrid();
                document.getElementById('status').textContent = `‚úÖ Map imported! (${width}√ó${height})`;
            } catch (error) {
                document.getElementById('status').textContent = `‚ùå Import failed: ${error.message}`;
                console.error(error);
            }
        }

        // ============================================================
        // MAP SIZE CONTROLS
        // ============================================================

        /**
         * Set preset map size
         */
        function setPresetSize(width, height) {
            document.getElementById('map-width').value = width;
            document.getElementById('map-height').value = height;
            updateSizeInfo();
        }

        /**
         * Get QR code version based on data size
         */
        function getQRVersion(base64Length) {
            // QR Code versions and their capacities (Medium error correction, alphanumeric)
            const versions = [
                { version: 1, capacity: 20 },
                { version: 2, capacity: 38 },
                { version: 3, capacity: 61 },
                { version: 4, capacity: 90 },
                { version: 5, capacity: 122 },
                { version: 10, capacity: 324 },
                { version: 15, capacity: 588 },
                { version: 20, capacity: 858 },
                { version: 25, capacity: 1118 },
                { version: 30, capacity: 1468 },
                { version: 35, capacity: 1794 },
                { version: 40, capacity: 2331 }
            ];

            for (const v of versions) {
                if (base64Length <= v.capacity) {
                    return v.version;
                }
            }
            return 40; // Max version
        }

        /**
         * Update size info display
         */
        function updateSizeInfo() {
            const width = parseInt(document.getElementById('map-width').value) || 40;
            const height = parseInt(document.getElementById('map-height').value) || 70;
            const totalTiles = width * height;
            const estimatedBytes = Math.ceil(totalTiles / 2) + 2; // 2 tiles per byte + header
            const base64Chars = Math.ceil(estimatedBytes * 4 / 3);
            const qrVersion = getQRVersion(base64Chars);

            // Update map size label
            document.getElementById('map-size-label').textContent =
                `Map Size (${totalTiles.toLocaleString()} tiles)`;

            // Update size info with QR version
            document.getElementById('size-info').textContent =
                `QR v${qrVersion} ‚Ä¢ ${base64Chars.toLocaleString()} chars`;
        }

        /**
         * Check if all tiles are empty (street tiles)
         */
        function isMapEmpty() {
            for (let row = 0; row < ROWS; row++) {
                for (let col = 0; col < COLS; col++) {
                    if (grid[row][col] !== 0) {
                        return false;
                    }
                }
            }
            return true;
        }

        /**
         * Resize the map grid
         */
        function resizeMap() {
            const newWidth = parseInt(document.getElementById('map-width').value);
            const newHeight = parseInt(document.getElementById('map-height').value);

            if (!newWidth || !newHeight || newWidth < 10 || newHeight < 10) {
                document.getElementById('status').textContent = '‚ùå Invalid size! Minimum 10√ó10';
                return;
            }

            if (newWidth > 60 || newHeight > 100) {
                document.getElementById('status').textContent = '‚ùå Map too large! Max 60√ó100';
                return;
            }

            // Only confirm if shrinking and map has data
            const isEmpty = isMapEmpty();
            if (!isEmpty && (newWidth < COLS || newHeight < ROWS) && !confirm('Shrinking the map will lose data. Continue?')) {
                document.getElementById('status').textContent = '‚ùå Resize cancelled';
                return;
            }

            saveHistory();

            // Create new grid
            const newGrid = Array(newHeight).fill(null).map(() => Array(newWidth).fill(0));

            // Copy existing data (preserve top-left corner)
            for (let row = 0; row < Math.min(ROWS, newHeight); row++) {
                for (let col = 0; col < Math.min(COLS, newWidth); col++) {
                    newGrid[row][col] = grid[row][col];
                }
            }

            // Update global constants and grid
            COLS = newWidth;
            ROWS = newHeight;
            grid = newGrid;

            renderGrid();
            updateSizeInfo();
            document.getElementById('status').textContent = `‚úÖ Map resized to ${newWidth}√ó${newHeight}`;
        }

        // Update size info when inputs change
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('map-width').addEventListener('input', updateSizeInfo);
            document.getElementById('map-height').addEventListener('input', updateSizeInfo);
            updateSizeInfo();
        });

        // ============================================================
        // CENTER MAP & RIGHT-CLICK PANNING
        // ============================================================

        /**
         * Center map view and reset zoom to 100%
         */
        function centerMap() {
            zoomLevel = 1.0;
            updateZoom();

            const container = document.getElementById('grid-container');
            const gridEl = document.getElementById('grid');

            // Center the grid in the viewport
            container.scrollLeft = (gridEl.scrollWidth - container.clientWidth) / 2;
            container.scrollTop = (gridEl.scrollHeight - container.clientHeight) / 2;

            document.getElementById('status').textContent = 'üéØ Map centered at 100% zoom';
        }

        /**
         * Right-click drag panning
         */
        let isPanning = false;
        let panStartX, panStartY, scrollLeft, scrollTop;

        const gridContainer = document.getElementById('grid-container');

        // Prevent default context menu on grid container
        gridContainer.addEventListener('contextmenu', (e) => {
            if (!fillMode) {
                e.preventDefault();
            }
        });

        // Start panning on right mouse button down
        gridContainer.addEventListener('mousedown', (e) => {
            if (e.button === 2 && !fillMode) { // Right mouse button
                isPanning = true;
                panStartX = e.pageX;
                panStartY = e.pageY;
                scrollLeft = gridContainer.scrollLeft;
                scrollTop = gridContainer.scrollTop;
                e.preventDefault();
            }
        });

        // Update scroll position during pan
        gridContainer.addEventListener('mousemove', (e) => {
            if (!isPanning) return;
            e.preventDefault();

            const dx = e.pageX - panStartX;
            const dy = e.pageY - panStartY;

            gridContainer.scrollLeft = scrollLeft - dx;
            gridContainer.scrollTop = scrollTop - dy;
        });

        // Stop panning on mouse up
        gridContainer.addEventListener('mouseup', (e) => {
            if (e.button === 2) {
                isPanning = false;
            }
        });

        // Stop panning if mouse leaves container
        gridContainer.addEventListener('mouseleave', () => {
            isPanning = false;
        });

        // Initialize
        initGrid();
        renderGrid();
        updateSavedMapsList();

        // Position viewport (no animation)
        requestAnimationFrame(() => {
            centerOnCameraStart();
        });
    </script>
</body>
</html>
